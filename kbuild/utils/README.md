# Description
The *generate_custom_archive.sh* script mimics what kbuild does for distros, targeting custom kernel instead.
In short, starting from a compiled custom kernel, it can generate a .tar.gz with the same format of those generated by kbuild, making it suitable for kernel build using the *kernel_module* bazel rule.

This is particularly useful for generating .tar.gz packages to be used for testing,
since most of the kernel config used for testing are usually disabled in the debian and ubuntu repositories (e.g. KUnit).

# Workflow
1. Download the kernel source code from somewhere into $KDIR
   * `git clone --depth 1 https://github.com/torvalds/linux.git $KDIR && cd $KDIR`
2. Configure and compile the kernel
   * `export ARCH=x # x being the architecture you want to compile the kernel for.`
   * `make defconfig && make menuconfig # Enable/disable stuff.`
   * `make`
   * Note: at this point, you have generated a `linux` file as well. This is a kernel executable image.
     If you previously specified `ARCH=um`, and enabled KUnit in the config, this image can be used by *kernel_test* rules.
     Documentation about the *kernel_test* rule can be found [here](https://github.com/enfabrica/enkit/blob/master/bazel/linux/README.md).
3. Execute the script and generate the .tar.gz inside $OUTDIR for your kernel version $KVER
   * `$ENKIT_REPO/kbuild/utils/generate_custom_archive.sh -k $KDIR -t $OUTDIR -v $KVER`
4. Optional: upload the .tar.gz using astore and make it public
   * `enkit astore upload $OUTDIR/$KVER.tar.gz@my/astore/path -a $ARCH`
   * `enkit astore public my/astore/path -a $ARCH`
