core.workflow(
    name = "default",
    origin = git.origin(
        url = "https://github.com/bazelbuild/bazel",
        ref = "fbd4427136a9e204fdd6f64d0bd2463aaa8ac322",  # master as of 02Dec2021
        partial_fetch = True,
    ),
    destination = git.github_pr_destination(
        url = "https://github.com/enfabrica/enkit",
        destination_ref = "master",
    ),
    origin_files = glob([
        "src/main/protobuf/command_line.proto",
        "src/main/protobuf/failure_details.proto",
        "src/main/protobuf/invocation_policy.proto",
        "src/main/protobuf/option_filters.proto",
        "src/main/java/com/google/devtools/build/lib/buildeventstream/proto/build_event_stream.proto",
    ]),
    destination_files = glob(
        ["third_party/bazel/**"],
        exclude = [
            "third_party/bazel/README.md",
            "third_party/bazel/**/BUILD.bazel",
        ],
    ),
    authoring = authoring.overwrite(default = "Copybara <noreply@enfabrica.net>"),
    transformations = [
        # Fix import paths
        core.replace(
            before = 'import "src/main/protobuf',
            after = 'import "third_party/bazel',
        ),
        # Flatten file hierarchy into //third_party/bazel
        core.move(
            before = "src/main/protobuf",
            after = "third_party/bazel",
            paths = glob(["*.proto"]),
        ),
        core.move(
            before = "src/main/java/com/google/devtools/build/lib/buildeventstream/proto/build_event_stream.proto",
            after = "third_party/bazel/build_event_stream.proto",
        ),
        metadata.add_header("Copybara update of third_party/bazel"),
        metadata.replace_message("Copybara update from github.com/bazelbuild/bazel to //third_party/bazel\nSee //third_party/bazel/README.md for more details."),
    ],
)
